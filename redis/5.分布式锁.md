# 分布式锁

## 锁的种类

* 单机锁：单机版同一个jvm内，synchronized或者Lock接口

* 分布式锁：分布式不同jvm内，单机的线程锁机制不再起作用，资源类在不同的服务器之间共享了

## 锁理念

* 独占性：任何时刻只能有一个线程持有

* 高可用：不能因为某个节点挂了而出现获取锁和释放锁失败的情况

* 防死锁：必须有超时控制机制或者撤销操作，有兜底的终止跳出方案

* 不乱抢：不能unlock别人的锁，只能自己加锁自己释放

* 重入性：同一个节点的同一个线程获得锁后，它可以再次获取锁

## CAP

单机redis是CP：具有强一致性

集群redis是AP：具有高可用，采用异步通知机制，一致性没这么强，只要通知到master就返回，让master再去通知其他节点

zookeeper集群是CP：强一致性，同步通知，必须是所有节点都通知到位才返回

## Redlock

### redisson简单使用

在java里的实现是redission，使用redisson.getLock方法获取分布式锁对象，调用lock方法和unlock方法即可实现分布式同步功能，注意unlock方法必须放在try-finally的finally块里，最好加上isLocked 和isHeldByCurrentThread方法判断 

![](images\10.png)

### 单机redis实现分布式锁

三个重要元素：

* 加锁：加锁实际上就是在redis中，给key键设置一个值，为避免死锁，给一个过期时间

* 解锁：将key删除。自己的key只能自己删除

* 超时：锁key要注意过期时间，不能长期占用 

加锁关键逻辑

![](images\8.png)

解锁关键逻辑：使用lua脚本保证redis命令的原子性

![](images\9.png)

单机redis的分布式锁在小业务中是可以使用的。

### redis集群实现分布式锁

建议至少使用三台机器（官网建议5台），这**三台机器都是master**，**使用多主模式** 

公式：N(部署台数) = 2X(宕机数) + 1

问：可以最多允许宕机一个服务器，请问集群需要多少台服务器？

答：3台

#### 设计理念

为解决数据不一致的问题，**直接舍弃了异步复制，只使用master节点**，同时由于舍弃了slave节点，为保证可用性，引入N个节点，官方建议是5.

客户端只有满足下面两个条件是，才能认为是加锁成功：

* 客户端从超过半数（>=N/2+1）的redis实例上成功获得锁；

* 客户端获取锁的总时间没有超过锁的有效时间；

### redisson缓存续命

#### 看门狗

额外起一个线程，定期检查线程是否还持有锁，如果有则延长过期时间。

Redisson 里面就实现了这个方案，使用“看门狗”定期检查(每1/3的锁时间检查1次)，如果线程还持有锁，则刷新过期时间

通过redisson新建出来的锁key，默认过期时间是30s。看门狗线程默认每隔10秒钟检测一次，如果锁未释放，看门狗会刷新锁key的过期时间，又回到30s

**添加锁的原码**

![](images\11.png)

1.红框表示当前不存在锁，设置key，并设置过期时间，上锁成功

2.黄框表示当前锁已存在，并且锁的是当前线程，通过hincrby给数值增加1，表示重入一次

3.最后一句表示锁已存在，但非本线程，返回过期时间ttl

**流程解释：**

1.通过exists判断，如果锁不存在，则设置值和过期时间，加锁成功

2.通过hexists判断，如果锁已存在，并且锁的是当前线程，则证明是重入锁，加锁成功

3.如果锁已存在，但锁的不是当前线程，则证明有其他线程持有锁，返回当前锁的过期时间，加锁失败

解锁原码

![](images\12.png)

1.如果释放锁的线程和已存在锁的线程不是同一个线程，返回null

2.通过hincrby递减1，先释放一次锁。若剩余次数还大于0，则证明当前锁是重入锁，刷新过期时间

3.若剩余次数小于等于0，删除key并发布锁释放的消息，解锁成功





**小问题**：redis分布式锁的实现，其他方式了解吗，对比数据库、redis、zk实现分布式锁，这三个从实现方式上和锁竞争上有什么不同？

1.CAP理论

2.实现底层原理

2.1 redis 按照一个key是否过期+lua脚本实现，官网推荐redlock算法的落地产品redisson

2.2 zookeeper 按照一个zk里面只可以有且仅有一个znode节点，加锁成功就是建立一个节点，到期使用完了，自己删除
2.3 两个为了避免单点故障，一般3台机器，zk是全体同步才返回消息，redis异同通知，容易出现mater宕机后，slave上位但锁丢失的情况。


